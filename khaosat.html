<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval'; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; connect-src 'self' https://sheets.googleapis.com https://*.googleapis.com https://*.google.com https://script.google.com https://script.googleusercontent.com; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net data:;">
    <title>Khảo sát - Hệ thống Khảo sát</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .home-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
        }
        
        .btn-home {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-home:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        
        @media (max-width: 768px) {
            .btn-home {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 20px;
                right: 20px;
            }
        }
        body {
            background-color: #f7f7f7;
        }
        .required-label::after {
            content: " *";
            color: red;
        }
        .currency-input {
            text-align: right;
        }
        .currency-input::placeholder { 
            text-align: left; 
        }
        .total-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .group-total {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
        }
        .card {
            margin-bottom: 25px;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        .card-header {
            border-bottom: none;
            padding: 15px 20px;
        }
        .card-body {
            padding: 20px;
        }
        .tooltip-icon {
            margin-left: 5px;
            color: #6c757d;
            cursor: help;
        }
        .form-control:focus, .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .btn-primary {
            background-color: #0d6efd;
            border: none;
            padding: 10px 20px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
        }

        .custom-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1050;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            display: none;
            min-width: 300px;
        }
        .custom-notification.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .notification-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            display: inline-block;
        }
        .success .notification-icon { color: #28a745; }
        .error .notification-icon { color: #dc3545; }

        .notification-message {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .overlay.show {
            opacity: 1;
        }
        .recommended-salary {
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        .form-text { 
            margin-top: 0.25rem;
            color: #6c757d;
            font-size: .875em;
        }
        .tooltip-inner {
            max-width: 300px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Hệ thống Khảo sát</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="khaosat.html">Khảo sát</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="overlay" id="pageOverlay"></div>

    <div class="custom-notification success" id="successNotification">
        <div class="notification-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="notification-message">Gửi khảo sát thành công!</div>
        <button class="btn btn-primary" id="closeSuccessNotification">Đóng</button>
    </div>

    <div class="custom-notification error" id="errorNotification">
        <div class="notification-icon">
            <i class="fas fa-times-circle"></i>
        </div>
        <div class="notification-message">Có lỗi xảy ra khi gửi khảo sát!</div>
        <div id="errorMessageDetail" style="margin-bottom: 20px; color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; padding: .75rem 1.25rem; border: 1px solid transparent; border-radius: .25rem;"></div>
        <button class="btn btn-danger" id="closeErrorNotification">Đóng</button>
    </div>

    <div class="container mt-4">
        <h2 class="mb-4">Form Khảo sát Chi phí Sinh hoạt</h2>
        <p class="text-muted mb-4">
            Khảo sát này nhằm thu thập thông tin về chi phí sinh hoạt và thu nhập hàng tháng của người lao động.
            Thông tin của bạn sẽ giúp chúng tôi đề xuất mức lương đủ sống phù hợp.
            Các trường đánh dấu <span class="text-danger">*</span> là bắt buộc.
        </p>
        <form id="formKhaoSat" class="mt-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">1. Thông tin cá nhân</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="hoTen" class="form-label required-label">Họ và tên</label>
                            <input type="text" class="form-control" id="hoTen" name="hoTen" required placeholder="Vui lòng nhập đầy đủ họ tên của bạn">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dienThoai" class="form-label required-label">Điện thoại</label>
                            <input type="tel" class="form-control" id="dienThoai" name="dienThoai" required placeholder="Số điện thoại của bạn, ví dụ: 0901234567">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="viTri" class="form-label required-label">Vị trí công việc</label>
                            <select class="form-select" id="viTri" name="viTri" required>
                                <option value="" disabled selected>Chọn vị trí...</option>
                                <option value="cong_nhan">Công nhân trực tiếp</option>
                                <option value="van_phong">Nhân viên Văn phòng</option>
                                <option value="khac">Khác</option>
                            </select>
                            <div class="form-text">Chọn vị trí công việc hiện tại của bạn</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="diaChi" class="form-label required-label">Địa chỉ</label>
                            <input type="text" class="form-control" id="diaChi" name="diaChi" required placeholder="Địa chỉ hiện tại của bạn">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="nguoiLon" class="form-label required-label">Số người lớn</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="nguoiLon" name="nguoiLon" min="1" value="1" required>
                                <span class="input-group-text" data-bs-toggle="tooltip" title="Số người từ 18 tuổi trở lên trong hộ gia đình">
                                    <i class="fas fa-info-circle"></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="treEm" class="form-label">Số trẻ em</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="treEm" name="treEm" min="0" value="0">
                                <span class="input-group-text" data-bs-toggle="tooltip" title="Số người dưới 18 tuổi trong hộ gia đình">
                                    <i class="fas fa-info-circle"></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="tongThanhVien" class="form-label">Tổng số thành viên</label>
                            <input type="text" class="form-control" id="tongThanhVien" name="tongThanhVien" readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="loaiNhaO" class="form-label required-label">Loại nhà ở</label>
                            <select class="form-select" id="loaiNhaO" name="loaiNhaO" required>
                                <option value="" disabled selected>Chọn loại nhà...</option>
                                <option value="nha_tro">Nhà thuê trọ</option>
                                <option value="nguyen_can">Thuê nhà Nguyên căn</option>
                                <option value="nha_rieng">Nhà riêng</option>
                            </select>
                             <div class="form-text">Chọn loại nhà ở hiện tại của bạn</div>
                        </div>
                        <div class="col-md-6 mb-3" id="chiPhiNhaOContainer">
                            <label for="chiPhiNhaO" class="form-label required-label">Chi phí nhà ở</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="chiPhiNhaO" name="chiPhiNhaO" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Tiền thuê nhà (không gồm điện, nước)">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">2. Chi phí sinh hoạt (VNĐ/tháng)</h5>
                </div>
                <div class="card-body">
                    <h6 class="fw-bold mb-3">2.1. Chi phí ăn uống</h6>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="gao" class="form-label">Gạo</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="gao" name="gao" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Chi phí gạo hàng tháng">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="thit" class="form-label">Thịt</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="thit" name="thit" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Chi phí các loại thịt">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="ca" class="form-label">Cá</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="ca" name="ca" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Chi phí các loại hải sản">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="rauCu" class="form-label">Rau củ</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="rauCu" name="rauCu" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Chi phí rau củ quả">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="sua" class="form-label">Sữa</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="sua" name="sua" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Chi phí sữa và sản phẩm sữa">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="giaVi" class="form-label">Gia vị</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="giaVi" name="giaVi" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Gia vị, dầu ăn, nước mắm...">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="group-total p-2 mt-4">
                                <div class="row">
                                    <div class="col-md-6">Tổng chi phí ăn uống:</div>
                                    <div class="col-md-6 text-end" id="tongChiPhiAnUong">0 VNĐ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="fw-bold mb-3 mt-4">2.2. Chi phí giáo dục</h6>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="hocPhi" class="form-label">Học phí</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="hocPhi" name="hocPhi" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Học phí trường học các cấp">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="sachVo" class="form-label">Sách vở</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="sachVo" name="sachVo" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Sách vở, đồ dùng học tập">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="dongPhuc" class="form-label">Đồng phục</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="dongPhuc" name="dongPhuc" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Chi phí đồng phục học sinh">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="khacGiaoDuc" class="form-label">Chi phí khác</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="khacGiaoDuc" name="khacGiaoDuc" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Bảo hiểm, đóng góp...">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 offset-md-6">
                            <div class="group-total p-2">
                                <div class="row">
                                    <div class="col-md-6">Tổng chi phí giáo dục:</div>
                                    <div class="col-md-6 text-end" id="tongChiPhiGiaoDuc">0 VNĐ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="fw-bold mb-3 mt-4">2.3. Chi phí tiện ích</h6>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="dien" class="form-label">Điện</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="dien" name="dien" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Chi phí điện hàng tháng">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="nuoc" class="form-label">Nước</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="nuoc" name="nuoc" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Nước sinh hoạt hàng tháng">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="internet" class="form-label">Internet</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="internet" name="internet" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Internet, điện thoại">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="rac" class="form-label">Rác</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="rac" name="rac" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Chi phí thu gom rác thải">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 offset-md-6">
                            <div class="group-total p-2">
                                <div class="row">
                                    <div class="col-md-6">Tổng chi phí tiện ích:</div>
                                    <div class="col-md-6 text-end" id="tongChiPhiTienIch">0 VNĐ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">3. Thu nhập (VNĐ/tháng)</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="thuNhapChinh" class="form-label required-label">Thu nhập chính</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="thuNhapChinh" name="thuNhapChinh" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Lương chính (đã trừ thuế, BH)">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="thuNhapPhu" class="form-label">Thu nhập phụ</label>
                            <div class="input-group">
                                <input type="text" class="form-control currency-input" id="thuNhapPhu" name="thuNhapPhu" 
                                       onkeyup="formatNumberInput(this)" onblur="formatNumberInput(this)" required placeholder="Làm thêm, kinh doanh, đầu tư...">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="total-box">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <h6>Tổng chi phí:</h6>
                        <p class="h4" id="tongChiPhi">0 VNĐ</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Tổng thu nhập:</h6>
                        <p class="h4" id="tongThuNhap">0 VNĐ</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Chênh lệch:</h6>
                        <p class="h4" id="chenhLech">0 VNĐ</p>
                    </div>
                </div>
                <div class="recommended-salary" id="recommendedSalaryBox">
                    <h5>Đề xuất mức lương đủ sống:</h5>
                    <p class="mb-0" id="recommendedSalary">Vui lòng điền đầy đủ thông tin để nhận đề xuất</p>
                </div>
                
                <div class="mb-4 mt-4">
                    <label for="mainGhiChu" class="form-label">Ghi chú</label>
                    <textarea class="form-control" id="mainGhiChu" name="mainGhiChu" rows="3" placeholder="Thông tin thêm bạn muốn chia sẻ"></textarea>
                </div>
                
                <div class="text-center mt-4 mb-3">
                    <div class="row">
                        <div class="col-md-6 offset-md-3">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                <button type="button" class="btn btn-outline-secondary btn-lg me-md-2" id="resetFormButton">
                                    <i class="fas fa-undo me-2"></i> Điền lại
                                </button>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i> Gửi khảo sát
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="home-button">
                <a href="index.html" class="btn btn-success btn-home">
                    <i class="fas fa-home"></i>
                </a>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        setupEventListeners();
        updateTotalMembers(); 
        handleNhaOTypeChange(); 
        updateAllTotals(); 
    });

    const pageOverlay = document.getElementById('pageOverlay');
    const successNotificationEl = document.getElementById('successNotification');
    const errorNotificationEl = document.getElementById('errorNotification');
    const errorMessageDetailEl = document.getElementById('errorMessageDetail');
    const formKhaoSat = document.getElementById('formKhaoSat');

    function setupEventListeners() {
        document.getElementById('nguoiLon').addEventListener('input', updateTotalMembers);
        document.getElementById('treEm').addEventListener('input', updateTotalMembers);
        document.getElementById('loaiNhaO').addEventListener('change', handleNhaOTypeChange);

        const currencyFields = document.querySelectorAll('.currency-input');
        currencyFields.forEach(element => {
            element.addEventListener('input', () => {
                updateAllTotals();
            });
        });
        
        document.getElementById('closeSuccessNotification').addEventListener('click', hideSuccessNotification);
        document.getElementById('closeErrorNotification').addEventListener('click', hideErrorNotification);
        
        formKhaoSat.addEventListener('submit', handleFormSubmit);
        
        document.getElementById('resetFormButton').addEventListener('click', function() {
            formKhaoSat.reset();
            document.getElementById('nguoiLon').value = '1'; 
            document.getElementById('treEm').value = '0';   
            updateTotalMembers();
            handleNhaOTypeChange();
            updateAllTotals(); 
            document.getElementById('chenhLech').style.color = 'inherit'; 
        });
    }

    function updateTotalMembers() {
        const nguoiLon = parseInt(document.getElementById('nguoiLon').value) || 0;
        const treEm = parseInt(document.getElementById('treEm').value) || 0;
        document.getElementById('tongThanhVien').value = nguoiLon + treEm;
        updateRecommendedSalary();
    }

    function handleNhaOTypeChange() {
        const loaiNhaO = document.getElementById('loaiNhaO').value;
        const chiPhiNhaOContainer = document.getElementById('chiPhiNhaOContainer');
        const chiPhiNhaOInput = document.getElementById('chiPhiNhaO');
        
        if (loaiNhaO === 'nha_rieng') {
            chiPhiNhaOContainer.style.display = 'none';
            chiPhiNhaOInput.value = ''; 
            chiPhiNhaOInput.required = false;
        } else {
            chiPhiNhaOContainer.style.display = 'block';
            chiPhiNhaOInput.required = true;
        }
        formatNumberInput(chiPhiNhaOInput); 
        updateAllTotals(); 
    }

    function formatNumberInput(input) {
        let value = input.value.replace(/[^\d]/g, '');
        if (value) {
            value = parseInt(value).toLocaleString('vi-VN');
        }
        input.value = value;
    }

    function parseFormattedNumber(str) {
        if (!str) return 0;
        return parseInt(String(str).replace(/\./g, '')) || 0;
    }

    function formatCurrency(number) {
        return new Intl.NumberFormat('vi-VN').format(number) + ' VNĐ';
    }

    function updateAllTotals() {
        tinhTongChiPhiAnUong();
        tinhTongChiPhiGiaoDuc();
        tinhTongChiPhiTienIch();
        tinhTongChiPhi();
        tinhTongThuNhap();
        tinhChenhLech();
        updateRecommendedSalary();
    }

    function tinhTongChiPhiAnUong() {
        const fields = ['gao', 'thit', 'ca', 'rauCu', 'sua', 'giaVi'];
        let tong = fields.reduce((sum, fieldId) => sum + parseFormattedNumber(document.getElementById(fieldId).value), 0);
        document.getElementById('tongChiPhiAnUong').textContent = formatCurrency(tong);
        return tong;
    }

    function tinhTongChiPhiGiaoDuc() {
        const fields = ['hocPhi', 'sachVo', 'dongPhuc', 'khacGiaoDuc'];
        let tong = fields.reduce((sum, fieldId) => sum + parseFormattedNumber(document.getElementById(fieldId).value), 0);
        document.getElementById('tongChiPhiGiaoDuc').textContent = formatCurrency(tong);
        return tong;
    }

    function tinhTongChiPhiTienIch() {
        const fields = ['dien', 'nuoc', 'internet', 'rac'];
        let tong = fields.reduce((sum, fieldId) => sum + parseFormattedNumber(document.getElementById(fieldId).value), 0);
        document.getElementById('tongChiPhiTienIch').textContent = formatCurrency(tong);
        return tong;
    }

    function tinhTongChiPhi() {
        let tong = tinhTongChiPhiAnUong() + tinhTongChiPhiGiaoDuc() + tinhTongChiPhiTienIch();
        if (document.getElementById('loaiNhaO').value !== 'nha_rieng') {
            tong += parseFormattedNumber(document.getElementById('chiPhiNhaO').value);
        }
        document.getElementById('tongChiPhi').textContent = formatCurrency(tong);
        return tong;
    }

    function tinhTongThuNhap() {
        const chinh = parseFormattedNumber(document.getElementById('thuNhapChinh').value);
        const phu = parseFormattedNumber(document.getElementById('thuNhapPhu').value);
        const tong = chinh + phu;
        document.getElementById('tongThuNhap').textContent = formatCurrency(tong);
        return tong;
    }

    function tinhChenhLech() {
        const thuNhap = tinhTongThuNhap();
        const chiPhi = tinhTongChiPhi();
        const chenhLech = thuNhap - chiPhi;
        const element = document.getElementById('chenhLech');
        element.textContent = formatCurrency(chenhLech);
        element.style.color = chenhLech >= 0 ? 'green' : 'red';
        return chenhLech;
    }

    function updateRecommendedSalary() {
        const tongThanhVien = parseInt(document.getElementById('tongThanhVien').value) || 0;
        const nguoiLon = parseInt(document.getElementById('nguoiLon').value) || 0;
        const treEm = parseInt(document.getElementById('treEm').value) || 0;
        
        const recommendedSalaryEl = document.getElementById('recommendedSalary');

        if (tongThanhVien <= 0 || nguoiLon <= 0) {
            recommendedSalaryEl.textContent = "Vui lòng điền đầy đủ thông tin về số thành viên trong gia đình";
            return;
        }
        
        const tongChiPhiValue = tinhTongChiPhi();
        const soThanhVienQuyDoi = nguoiLon + (treEm * 0.7);
        
        if (soThanhVienQuyDoi === 0) { 
             recommendedSalaryEl.textContent = "Số thành viên quy đổi không hợp lệ.";
             return;
        }

        const chiPhiTrungBinh = tongChiPhiValue / soThanhVienQuyDoi;
        const luongDeXuat = chiPhiTrungBinh * soThanhVienQuyDoi / nguoiLon; 
        const luongDeXuatFinal = luongDeXuat * 1.1; 
        
        recommendedSalaryEl.innerHTML = `
            <strong>${formatCurrency(Math.round(luongDeXuatFinal))}</strong> / người lao động / tháng
            <p class="mt-2 mb-0 small text-muted">Dựa trên chi phí sinh hoạt của ${soThanhVienQuyDoi.toFixed(1)} thành viên quy đổi, 
            với ${nguoiLon} người lao động trong gia đình. Đã bao gồm 10% cho tiết kiệm và chi phí phát sinh.</p>
        `;
    }

    function showOverlay() {
        pageOverlay.style.display = 'block';
        requestAnimationFrame(() => pageOverlay.classList.add('show'));
    }

    function hideOverlay() {
        pageOverlay.classList.remove('show');
        setTimeout(() => {
            pageOverlay.style.display = 'none';
        }, 300); 
    }
    
    function showNotification(notificationEl) {
        showOverlay();
        notificationEl.style.display = 'block';
        requestAnimationFrame(() => { 
            notificationEl.classList.add('show');
        });
    }

    function hideNotification(notificationEl, callback) {
        notificationEl.classList.remove('show');
        setTimeout(() => {
            notificationEl.style.display = 'none';
            if (document.querySelectorAll('.custom-notification.show').length === 0) {
                 hideOverlay();
            }
            if (callback) callback();
        }, 300); 
    }

    function showSuccessNotification() {
        showNotification(successNotificationEl);
    }

    function hideSuccessNotification() {
        hideNotification(successNotificationEl);
    }
    
    function showErrorNotification(message) {
        errorMessageDetailEl.textContent = message;
        showNotification(errorNotificationEl);
    }

    function hideErrorNotification() {
        hideNotification(errorNotificationEl);
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const submitButton = formKhaoSat.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;

        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang gửi...';
        submitButton.disabled = true;
        
        try {
            const formData = new FormData(formKhaoSat);
            formData.append('tongThanhVien', document.getElementById('tongThanhVien').value);
            
            const numberFields = [
                'chiPhiNhaO', 'gao', 'thit', 'ca', 'rauCu', 'sua', 'giaVi',
                'hocPhi', 'sachVo', 'dongPhuc', 'khacGiaoDuc',
                'dien', 'nuoc', 'internet', 'rac',
                'thuNhapChinh', 'thuNhapPhu'
            ];
            numberFields.forEach(field => {
                const element = document.getElementById(field);
                if (element) { 
                     if (element.closest('.mb-3').style.display !== 'none') { 
                        formData.set(field, parseFormattedNumber(element.value));
                     } else {
                        formData.set(field, 0); 
                     }
                }
            });
            
            formData.append('tongChiPhiSinhHoat', tinhTongChiPhi());
            formData.append('tongThuNhapCaNhan', tinhTongThuNhap());
            formData.append('chenhLechThuChi', tinhChenhLech());
            formData.append('timestamp', new Date().toISOString());
            
            const response = await fetch('https://script.google.com/macros/s/AKfycbxVjXAiM3-W3bxNUnmrx-BfZe1sIHAV9h3qhp7T2Y4IB4aEGalvvch6-l5qimz7u7jdsA/exec', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.text();
            
            if (response.ok && result.toLowerCase().includes('ok')) { 
                showSuccessNotification();
                formKhaoSat.reset(); 

                document.getElementById('nguoiLon').value = '1';
                document.getElementById('treEm').value = '0';
                updateTotalMembers(); 
                handleNhaOTypeChange(); 
                updateAllTotals(); 
                document.getElementById('chenhLech').style.color = 'inherit';
            } else {
                showErrorNotification('Lỗi từ máy chủ: ' + result);
            }
        } catch (error) {
            console.error('Lỗi khi gửi form:', error);
            showErrorNotification('Lỗi kết nối hoặc xử lý: ' + error.message);
        } finally {
            submitButton.innerHTML = originalButtonText;
            submitButton.disabled = false;
        }
    }
    </script>
</body>
</html>
